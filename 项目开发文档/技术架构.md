# MeetMind 技术架构

> 详细的技术栈、系统架构、数据存储、数据流动、WebSocket 代理架构说明

---

## 技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| **框架** | Next.js (App Router) | ^14.2.0 |
| **语言** | TypeScript | ^5.3.0 |
| **样式** | Tailwind CSS | ^3.4.0 |
| **状态管理** | Zustand | ^4.5.0 |
| **数据获取** | SWR | ^2.3.0 |
| **本地存储** | Dexie (IndexedDB) | ^4.2.1 |
| **AI SDK** | Vercel AI SDK | ^6.0.11 |
| **音频处理** | wavesurfer.js | ^7.12.1 |
| **音频转换** | fluent-ffmpeg | ^2.1.3 |
| **可视化** | @nivo/heatmap | ^0.99.0 |
| **网络** | ws, axios | latest |

---

## 数据层架构

### SWR 数据获取层

项目使用 SWR 实现统一的数据获取和缓存策略，遵循 `stale-while-revalidate` 模式。

#### 核心配置

```
src/lib/swr/
├── fetcher.ts      # 统一 fetcher（支持 auth、JSON、FormData）
└── provider.tsx    # SWR 全局配置 Provider
```

#### 数据 Hooks

```
src/hooks/data/
├── useTopics.ts      # 精选片段数据（生成、重新生成、按主题重新生成）
├── useSummary.ts     # 摘要数据（生成、清除）
├── useTutor.ts       # AI 家教数据（解释困惑点、对话）
├── useSession.ts     # 会话管理（列表、详情、创建）
└── useTranscript.ts  # 转录数据（获取、追加、批量操作）
```

#### SWR 配置策略

| 配置项 | 值 | 说明 |
|--------|-----|------|
| `revalidateOnFocus` | false | 切换 Tab 不自动刷新 |
| `dedupingInterval` | 5000-10000ms | 请求去重间隔 |
| `errorRetryCount` | 3 | 错误重试次数 |
| `shouldRetryOnError` | true | 启用错误重试 |

### Zustand 状态管理

项目使用 Zustand 管理复杂的客户端状态，采用分层 store 设计。

#### Store 结构

```
src/stores/
├── ui-store.ts       # UI 状态
│   ├── drawer（开关状态、类型）
│   ├── modal（开关状态、内容）
│   └── toast（消息队列）
│
└── player-store.ts   # 播放器状态
    ├── 播放状态（isPlaying、currentTime、duration）
    ├── 音量控制（volume、isMuted）
    └── 播放列表（playlist、currentIndex）
```

#### 使用示例

```typescript
// 组件中使用
import { useUIStore } from '@/stores/ui-store';
import { usePlayerStore } from '@/stores/player-store';

function MyComponent() {
  const { openDrawer, closeDrawer } = useUIStore();
  const { isPlaying, togglePlay } = usePlayerStore();
  // ...
}
```

---

## 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   客户端层                                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                  │
│  │    学生端 (/)    │  │  家长端 (/parent)│  │ 教师端 (/teacher)│                  │
│  │                 │  │                 │  │                 │                  │
│  │ • 课堂录音       │  │ • 今日概览      │  │ • 困惑热点 TOP3  │                  │
│  │ • 困惑点标记     │  │ • 困惑点列表    │  │ • 学生困惑列表   │                  │
│  │ • AI 家教对话    │  │ • 陪学脚本      │  │ • AI 教学反思    │                  │
│  │ • 时间轴复习     │  │ • 任务清单      │  │ • 课堂数据统计   │                  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘                  │
│           │                    │                    │                           │
│           └────────────────────┼────────────────────┘                           │
│                                │                                                │
│  ┌─────────────────────────────┴─────────────────────────────┐                  │
│  │                     React 组件层                           │                  │
│  │  Recorder | AITutor | TimelineView | WaveformPlayer | ...  │                  │
│  └─────────────────────────────┬─────────────────────────────┘                  │
└────────────────────────────────┼────────────────────────────────────────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │     HTTP / WebSocket    │
                    └────────────┬────────────┘
                                 │
┌────────────────────────────────┼────────────────────────────────────────────────┐
│                                │           服务端层                               │
│  ┌─────────────────────────────┴─────────────────────────────┐                  │
│  │                    server.js (自定义服务器)                 │                  │
│  │  ┌─────────────────────────────────────────────────────┐  │                  │
│  │  │              HTTP Server (port 3001)                 │  │                  │
│  │  │                                                      │  │                  │
│  │  │  ┌──────────────┐    ┌──────────────────────────┐   │  │                  │
│  │  │  │ Next.js App  │    │   WebSocket 升级分发      │   │  │                  │
│  │  │  │   Handler    │    │                          │   │  │                  │
│  │  │  │              │    │  /api/asr-stream → ASR代理│   │  │                  │
│  │  │  │ • API Routes │    │  /_next/* → Next.js HMR  │   │  │                  │
│  │  │  │ • Pages      │    │                          │   │  │                  │
│  │  │  └──────────────┘    └──────────────────────────┘   │  │                  │
│  │  └─────────────────────────────────────────────────────┘  │                  │
│  └───────────────────────────────────────────────────────────┘                  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────┐                  │
│  │                    Next.js API Routes                      │                  │
│  │                                                            │                  │
│  │  /api/tutor          AI 家教 (解释困惑点、生成行动清单)     │                  │
│  │  /api/chat           通用 AI 对话                          │                  │
│  │  /api/transcribe     批处理语音转录 (WebM → WAV → ASR)     │                  │
│  │  /api/generate-*     内容生成 (摘要、精选片段、主题)        │                  │
│  │  /api/asr-config     ASR 配置信息                          │                  │
│  │  /api/auth/*         用户认证 (JWT)                        │                  │
│  └───────────────────────────────────────────────────────────┘                  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────┐                  │
│  │                      服务层 (src/lib/services/)            │                  │
│  │                                                            │                  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │                  │
│  │  │ llm-service  │  │qwen-asr-svc  │  │ dify-service │     │                  │
│  │  │ (通义千问)    │  │ (语音识别)    │  │ (工作流)     │     │                  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘     │                  │
│  │                                                            │                  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │                  │
│  │  │meetmind-svc  │  │classroom-data│  │ anchor-svc   │     │                  │
│  │  │ (核心业务)    │  │ (数据共享)    │  │ (困惑点)     │     │                  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘     │                  │
│  │                                                            │                  │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │                  │
│  │  │highlight-svc │  │ summary-svc  │  │ parent-svc   │     │                  │
│  │  │ (精选片段)    │  │ (课堂摘要)    │  │ (家长报告)   │     │                  │
│  │  └──────────────┘  └──────────────┘  └──────────────┘     │                  │
│  └───────────────────────────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────────┘
                                 │
                    ┌────────────┴────────────┐
                    │      外部服务调用        │
                    └────────────┬────────────┘
                                 │
┌────────────────────────────────┼────────────────────────────────────────────────┐
│                                │           外部服务层                             │
│  ┌─────────────────────────────┴─────────────────────────────┐                  │
│  │                                                            │                  │
│  │  ┌──────────────────┐  ┌──────────────────┐               │                  │
│  │  │   阿里云百炼      │  │      Dify        │               │                  │
│  │  │   (DashScope)    │  │    (可选)        │               │                  │
│  │  │                  │  │                  │               │                  │
│  │  │ • qwen3-max      │  │ • 引导问题工作流  │               │                  │
│  │  │   (LLM 对话)     │  │                  │               │                  │
│  │  │                  │  │                  │               │                  │
│  │  │ • qwen3-asr-flash│  │                  │               │                  │
│  │  │   (批处理转录)   │  │                  │               │                  │
│  │  │                  │  │                  │               │                  │
│  │  │ • qwen3-asr-     │  │                  │               │                  │
│  │  │   flash-realtime │  │                  │               │                  │
│  │  │   (实时转录)     │  │                  │               │                  │
│  │  │                  │  │                  │               │                  │
│  │  │ • qwen3-asr-     │  │                  │               │                  │
│  │  │   flash-filetrans│  │                  │               │                  │
│  │  │   (异步文件转录) │  │                  │               │                  │
│  │  └──────────────────┘  └──────────────────┘               │                  │
│  │                                                            │                  │
│  └────────────────────────────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 数据存储架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              客户端数据存储                                       │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        IndexedDB (Dexie.js)                              │   │
│  │                                                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │  audioSessions  │  │   transcripts   │  │     anchors     │          │   │
│  │  │                 │  │                 │  │                 │          │   │
│  │  │ • sessionId     │  │ • id            │  │ • id            │          │   │
│  │  │ • audioBlob     │  │ • sessionId     │  │ • sessionId     │          │   │
│  │  │ • createdAt     │  │ • text          │  │ • timestamp     │          │   │
│  │  │ • duration      │  │ • startMs       │  │ • type          │          │   │
│  │  │ • subject       │  │ • endMs         │  │ • resolved      │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  │                                                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│  │  │ highlightTopics │  │  classSummaries │  │      notes      │          │   │
│  │  │                 │  │                 │  │                 │          │   │
│  │  │ • id            │  │ • id            │  │ • id            │          │   │
│  │  │ • sessionId     │  │ • sessionId     │  │ • sessionId     │          │   │
│  │  │ • title         │  │ • overview      │  │ • content       │          │   │
│  │  │ • segments[]    │  │ • takeaways[]   │  │ • timestamp     │          │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘          │   │
│  │                                                                          │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                               │   │
│  │  │tutorResponseCache│ │   preferences   │                               │   │
│  │  │                 │  │                 │                               │   │
│  │  │ • anchorId      │  │ • key           │                               │   │
│  │  │ • response      │  │ • value         │                               │   │
│  │  │ • model         │  │                 │                               │   │
│  │  └─────────────────┘  └─────────────────┘                               │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                           localStorage                                   │   │
│  │                                                                          │   │
│  │  • meetmind_access_token    JWT 认证令牌                                 │   │
│  │  • meetmind_refresh_token   刷新令牌                                     │   │
│  │  • app_last_state           应用状态 (viewMode, sessionId, etc.)        │   │
│  └──────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 数据流动架构

### 1. 录音转录流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                            录音转录数据流                                      │
│                                                                              │
│  ┌─────────┐                                                                 │
│  │  用户   │ 点击录音按钮                                                     │
│  └────┬────┘                                                                 │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    Recorder 组件                                     │    │
│  │                                                                      │    │
│  │  1. navigator.mediaDevices.getUserMedia() 获取麦克风                 │    │
│  │  2. AudioContext (16kHz) 创建音频上下文                              │    │
│  │  3. ScriptProcessorNode 处理 PCM 数据                                │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│              ┌──────────────┴──────────────┐                                │
│              │                             │                                │
│              ▼                             ▼                                │
│  ┌─────────────────────┐      ┌─────────────────────┐                       │
│  │    流式模式 (实时)   │      │   上传模式 (异步)    │                       │
│  │                     │      │                     │                       │
│  │  PCM 二进制数据      │      │  用户上传音频文件    │                       │
│  │       │             │      │  (MP3/M4A/WAV等)   │                       │
│  │       ▼             │      │       │             │                       │
│  │  WebSocket 发送     │      │       ▼             │                       │
│  │  ws://localhost:    │      │  保存到             │                       │
│  │  3001/api/asr-stream│      │  public/temp-audio/ │                       │
│  └──────────┬──────────┘      └──────────┬──────────┘                       │
│             │                            │                                  │
│             ▼                            ▼                                  │
│  ┌─────────────────────┐      ┌─────────────────────┐                       │
│  │    server.js        │      │   API Route         │                       │
│  │    WebSocket 代理   │      │   /api/transcribe   │                       │
│  │                     │      │                     │                       │
│  │  PCM → Base64       │      │  构建公网 URL       │                       │
│  │  转发到 DashScope   │      │  提交异步任务       │                       │
│  │                     │      │  轮询等待结果       │                       │
│  └──────────┬──────────┘      └──────────┬──────────┘                       │
│             │                            │                                  │
│             ▼                            ▼                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      阿里云百炼 DashScope                            │    │
│  │                                                                      │    │
│  │  • qwen3-asr-flash-realtime (实时流式)                               │    │
│  │  • qwen3-asr-flash-filetrans (异步文件转录，支持长音频)              │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                       转录结果                                       │    │
│  │                                                                      │    │
│  │  TranscriptSegment[] = [                                             │    │
│  │    { id, text, startMs, endMs, confidence, isFinal }                │    │
│  │  ]                                                                   │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     IndexedDB 存储                                   │    │
│  │                                                                      │    │
│  │  audioSessions: 音频 Blob                                            │    │
│  │  transcripts: 转录片段                                               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 2. AI 家教对话流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          AI 家教对话数据流                                     │
│                                                                              │
│  ┌─────────┐                                                                 │
│  │  学生   │ 点击困惑点                                                       │
│  └────┬────┘                                                                 │
│       │                                                                      │
│       ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    AITutor 组件                                      │    │
│  │                                                                      │    │
│  │  1. 获取困惑点时间戳                                                  │    │
│  │  2. 从 IndexedDB 读取前后 90s/60s 转录片段                           │    │
│  │  3. 构建请求 payload                                                 │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    POST /api/tutor                                   │    │
│  │                                                                      │    │
│  │  Request:                                                            │    │
│  │  {                                                                   │    │
│  │    timestamp: 125000,           // 困惑点时间戳 (ms)                  │    │
│  │    segments: [...],             // 转录片段                          │    │
│  │    model: "qwen3-max",          // LLM 模型                          │    │
│  │    enable_guidance: true,       // 启用引导问题                       │    │
│  │    enable_web: false,           // 联网搜索                          │    │
│  │    subject: "英语"              // 学科                              │    │
│  │  }                                                                   │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    tutor-service.ts                                  │    │
│  │                                                                      │    │
│  │  1. 构建 System Prompt (包含课堂上下文)                              │    │
│  │  2. 调用 llm-service.ts → DashScope API                             │    │
│  │  3. 流式返回响应                                                     │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    AI 响应结构                                       │    │
│  │                                                                      │    │
│  │  ## 老师是这样讲的                                                   │    │
│  │  [02:05-02:15] "Australia is often called..."                       │    │
│  │                                                                      │    │
│  │  ## 帮我定位你的困惑                                                 │    │
│  │  A. 不理解为什么名字会重复说两遍                                     │    │
│  │  B. 分不清昵称和全名的区别                                           │    │
│  │  C. 听不清具体发音                                                   │    │
│  │  D. 不理解文化背景或语法结构                                         │    │
│  │                                                                      │    │
│  │  ## 今晚行动清单（20分钟）                                           │    │
│  │  1. ✅ [回放] 再听一遍 02:05-02:15                                   │    │
│  │  2. ✅ [练习] 跟读句子，注意发音                                     │    │
│  │  3. ✅ [复习] 总结澳大利亚别称的知识点                               │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    缓存到 IndexedDB                                  │    │
│  │                                                                      │    │
│  │  tutorResponseCache: { anchorId, response, model, timestamp }       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 3. 三端数据共享流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                          三端数据共享流程                                      │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                         学生端 (/)                                   │    │
│  │                                                                      │    │
│  │  录音 → 转录 → 标记困惑点 → AI 对话 → 生成摘要                        │    │
│  │                                                                      │    │
│  │  数据写入:                                                           │    │
│  │  • audioSessions (音频)                                              │    │
│  │  • transcripts (转录)                                                │    │
│  │  • anchors (困惑点)                                                  │    │
│  │  • highlightTopics (精选片段)                                        │    │
│  │  • classSummaries (课堂摘要)                                         │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             │ classroomDataService                          │
│                             │ (数据共享服务)                                 │
│                             │                                                │
│              ┌──────────────┴──────────────┐                                │
│              │                             │                                │
│              ▼                             ▼                                │
│  ┌─────────────────────┐      ┌─────────────────────┐                       │
│  │   家长端 (/parent)   │      │   教师端 (/teacher)  │                       │
│  │                     │      │                     │                       │
│  │  读取数据:           │      │  读取数据:           │                       │
│  │  • 困惑点列表        │      │  • 全班困惑点汇总    │                       │
│  │  • 课堂摘要          │      │  • 困惑热点 TOP3     │                       │
│  │  • 行动清单          │      │  • 学生列表          │                       │
│  │                     │      │                     │                       │
│  │  生成内容:           │      │  生成内容:           │                       │
│  │  • 陪学脚本          │      │  • AI 教学反思       │                       │
│  │  • 任务清单          │      │  • 改进建议          │                       │
│  └─────────────────────┘      └─────────────────────┘                       │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    数据共享机制                                      │    │
│  │                                                                      │    │
│  │  classroomDataService.ts:                                            │    │
│  │                                                                      │    │
│  │  • getSessionData(sessionId)     获取会话数据                        │    │
│  │  • getConfusionPoints(sessionId) 获取困惑点列表                       │    │
│  │  • getTranscripts(sessionId)     获取转录内容                        │    │
│  │  • aggregateConfusions()         汇总全班困惑                        │    │
│  │                                                                      │    │
│  │  数据来源优先级:                                                     │    │
│  │  1. IndexedDB (真实录音数据)                                         │    │
│  │  2. demo-data.ts (演示数据)                                          │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## WebSocket 代理架构

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        WebSocket 实时转录架构                                  │
│                                                                              │
│  ┌─────────────────┐                                                         │
│  │   浏览器        │                                                         │
│  │   Recorder.tsx  │                                                         │
│  │                 │                                                         │
│  │  AudioContext   │                                                         │
│  │  (16kHz, mono)  │                                                         │
│  └────────┬────────┘                                                         │
│           │                                                                  │
│           │ PCM Int16 二进制数据                                              │
│           │                                                                  │
│           ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              WebSocket 连接: ws://localhost:3001/api/asr-stream      │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        server.js                                     │    │
│  │                                                                      │    │
│  │  server.on('upgrade', (req, socket, head) => {                      │    │
│  │    if (pathname === '/api/asr-stream') {                            │    │
│  │      wss.handleUpgrade(...)  // ASR 代理处理                         │    │
│  │    } else {                                                          │    │
│  │      nextUpgradeHandler(...) // Next.js HMR 处理                     │    │
│  │    }                                                                 │    │
│  │  })                                                                  │    │
│  │                                                                      │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │                    ASR 代理逻辑                              │    │    │
│  │  │                                                              │    │    │
│  │  │  1. 客户端连接 → 建立到 DashScope 的 WebSocket              │    │    │
│  │  │  2. 发送 session.update (配置音频格式、VAD)                  │    │    │
│  │  │  3. 接收客户端 PCM → Base64 编码 → 转发                     │    │    │
│  │  │  4. 接收 DashScope 结果 → 解析 → 发送给客户端               │    │    │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  └──────────────────────────┬──────────────────────────────────────────┘    │
│                             │                                                │
│                             │ WebSocket + Authorization Header              │
│                             │                                                │
│                             ▼                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │              wss://dashscope.aliyuncs.com/api-ws/v1/realtime         │    │
│  │              ?model=qwen3-asr-flash-realtime                         │    │
│  │                                                                      │    │
│  │  事件流:                                                             │    │
│  │  → session.update (配置)                                             │    │
│  │  ← session.created                                                   │    │
│  │  ← session.updated (ready)                                           │    │
│  │  → input_audio_buffer.append (Base64 音频)                           │    │
│  │  ← input_audio_buffer.speech_started                                 │    │
│  │  ← conversation.item.input_audio_transcription.completed             │    │
│  │  → input_audio_buffer.commit (停止)                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    客户端接收的事件                                   │    │
│  │                                                                      │    │
│  │  { event: 'ready' }                    会话就绪                       │    │
│  │  { event: 'result', sentence: {...} }  转录结果                       │    │
│  │  { event: 'interim', text: '...' }     增量文本                       │    │
│  │  { event: 'error', error: '...' }      错误信息                       │    │
│  │  { event: 'closed', code: 1000 }       连接关闭                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心业务流程

### 录音转录流程

```
用户点击录音 → 获取麦克风权限 → 创建 AudioContext (16kHz)
                                        │
                    ┌───────────────────┴───────────────────┐
                    ▼                                       ▼
            流式模式 (实时)                        上传模式 (异步长音频)
            qwen3-asr-flash-realtime           qwen3-asr-flash-filetrans
                    │                                       │
                    ▼                                       ▼
            WebSocket 代理                           用户上传音频文件
            (server.js 统一 upgrade 分发)           保存到 public/temp-audio/
                    │                                       │
                    ▼                                       ▼
            实时返回句子                             构建公网 URL
            {text, beginTime, endTime}              http://服务器IP:3001/temp-audio/xxx.m4a
                    │                                       │
                    │                                       ▼
                    │                              调用 /api/transcribe
                    │                              1. 提交异步任务到阿里云
                    │                              2. 轮询等待结果 (最长10分钟)
                    │                              3. 返回带时间戳的句子列表
                    │                                       │
                    └───────────────────┬───────────────────┘
                                        ▼
                              构建课堂时间轴 (memoryService)
                              关联困惑点锚点
                                        │
                                        ▼
                              保存到 IndexedDB
                              切换到复习模式
```

### 异步转录详细流程

```
用户上传音频 → POST /api/transcribe
                    │
                    ▼
        ┌─────────────────────────────┐
        │  1. 验证文件格式和大小        │
        │     (最大 500MB)             │
        └─────────────┬───────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │  2. 保存到 public/temp-audio │
        │     生成唯一文件名            │
        └─────────────┬───────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │  3. 构建公网 URL             │
        │     http://IP:3001/temp-audio/xxx.m4a │
        └─────────────┬───────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │  4. 提交异步任务到阿里云      │
        │     POST /services/audio/asr/transcription │
        │     X-DashScope-Async: enable │
        └─────────────┬───────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │  5. 轮询任务状态 (每3秒)     │
        │     GET /tasks/{task_id}    │
        │     等待 SUCCEEDED/FAILED   │
        └─────────────┬───────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │  6. 获取转录结果             │
        │     从 transcription_url 下载 │
        │     解析 sentences 数组      │
        └─────────────┬───────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │  7. 清理临时文件             │
        │     删除 temp-audio 中的文件 │
        │     (2小时自动清理)          │
        └─────────────────────────────┘
```


### AI 家教对话流程

```
学生选择困惑点 → 获取前后 90秒/60秒 转录片段
                          │
                          ▼
                调用 /api/tutor
                {timestamp, segments, model, enable_guidance, enable_web}
                          │
                          ▼
                ┌─────────────────────────────────────────┐
                │  AI 响应结构                             │
                │                                         │
                │  ## 老师是这样讲的                       │
                │  [可点击时间戳] 转录文本（点击跳转播放） │
                │                                         │
                │  ## 帮我定位你的困惑（选择题模式）       │
                │  A. 不理解为什么名字会重复说两遍        │
                │  B. 分不清昵称和全名的区别              │
                │  C. 听不清具体发音                      │
                │  D. 不理解文化背景或语法结构            │
                │                                         │
                │  ## 今晚行动清单（20分钟）               │
                │  1. ✅ [回放] 再听一遍 xx:xx-xx:xx      │
                │  2. ✅ [练习] 做一道类似题目             │
                │  3. ✅ [复习] 总结知识点                 │
                └─────────────────────────────────────────┘
```

---

*文档版本：v2.0*  
*更新时间：2026-01-19*  
*更新内容：新增阿里云异步 ASR 转录架构*
