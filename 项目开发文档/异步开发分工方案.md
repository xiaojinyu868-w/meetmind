# MeetMind 异步 Git 开发分工方案 v2.0

> 更新日期：2026-01-22
> 基于 v1.8 架构优化后的项目结构

---

## 核心原则

按**「功能垂直切片」**分工，而非「技术水平切片」

- ❌ 不好的分工：前端组 vs 后端组 vs 数据库组
- ✅ 好的分工：按功能模块，每人负责完整链路

---

## 📦 模块划分（5人团队）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        MeetMind 功能模块 v2.0                            │
├───────────────┬───────────────┬───────────────┬───────────────┬─────────┤
│  🎙️ 录音转写    │  🤖 AI家教     │  📝 笔记/内容   │  👨‍👩‍👧 多角色端    │  🔐 基建  │
│    模块        │    模块        │    模块        │    模块        │  模块   │
├───────────────┼───────────────┼───────────────┼───────────────┼─────────┤
│ components/   │ components/   │ components/   │ app/parent/   │ api/auth│
│  Recorder     │  AITutor      │  NotesPanel   │ app/teacher/  │ lib/    │
│  AudioUploader│  Citations    │  HighlightsPanel components/ │  hooks/ │
│ api/transcribe│ api/tutor/    │  SummaryPanel │   parent/     │  useAuth│
│ services/     │ api/chat/     │ services/     │   teacher/    │ services│
│  qwen-asr-*   │ services/     │  note-service │ services/     │  auth-* │
│  dashscope-*  │  llm-service  │  highlight-*  │  classroom-*  │ prisma/ │
│ server.js     │  tutor-service│  summary-*    │  parent-*     │middleware│
│ (ASR 部分)    │ hooks/data/   │ hooks/data/   │               │         │
│               │  useTutor     │  useSummary   │               │         │
│               │               │  useTopics    │               │         │
├───────────────┼───────────────┼───────────────┼───────────────┼─────────┤
│   开发者 A    │   开发者 B    │   开发者 C    │   开发者 D    │ 开发者 E │
└───────────────┴───────────────┴───────────────┴───────────────┴─────────┘
```

---

## 📁 详细目录边界

### 开发者 A - 录音转写模块

| 主要负责 | 文件路径 |
|----------|----------|
| **组件** | `components/Recorder.tsx` (29KB) |
| | `components/AudioUploader.tsx` |
| | `components/WaveformPlayer.tsx` (23KB) |
| **API** | `api/transcribe/route.ts` |
| | `api/transcribe-fast/route.ts` |
| | `api/transcribe-turbo/route.ts` |
| | `api/transcribe/status/route.ts` |
| | `api/upload-audio/route.ts` |
| | `api/asr-config/route.ts` |
| **服务** | `services/qwen-asr-service.ts` (19KB) |
| | `services/dashscope-asr-service.ts` |
| **其他** | `server.js` (ASR WebSocket 部分) |

### 开发者 B - AI 家教模块

| 主要负责 | 文件路径 |
|----------|----------|
| **组件** | `components/AITutor.tsx` (39KB，核心) |
| | `components/AIChat.tsx` |
| | `components/Citations.tsx` |
| | `components/ModelSelector.tsx` |
| **API** | `api/tutor/route.ts` (33KB) |
| | `api/chat/route.ts` |
| **服务** | `services/llm-service.ts` (11KB) |
| | `services/tutor-service.ts` |
| | `services/dify-service.ts` |
| | `services/conversation-service.ts` |
| **Hooks** | `hooks/data/useTutor.ts` |
| | `hooks/useConversationHistory.ts` (12KB) |
| **类型** | `types/dify.ts` |

### 开发者 C - 笔记/内容模块

| 主要负责 | 文件路径 |
|----------|----------|
| **组件** | `components/NotesPanel.tsx` |
| | `components/HighlightsPanel.tsx` |
| | `components/SummaryPanel.tsx` |
| | `components/TimelineView.tsx` |
| | `components/AnchorDetailPanel.tsx` |
| **API** | `api/generate-summary/route.ts` |
| | `api/generate-topics/route.ts` |
| **服务** | `services/note-service.ts` |
| | `services/highlight-service.ts` (25KB) |
| | `services/summary-service.ts` |
| | `services/anchor-service.ts` |
| **Hooks** | `hooks/data/useSummary.ts` |
| | `hooks/data/useTopics.ts` |
| | `hooks/data/useTranscript.ts` |
| **工具** | `lib/longcut/*` (引用匹配、时间戳等) |

### 开发者 D - 多角色端模块

| 主要负责 | 文件路径 |
|----------|----------|
| **页面** | `app/parent/page.tsx` |
| | `app/teacher/page.tsx` |
| **组件** | `components/parent/*` (全部) |
| | `components/teacher/*` (全部) |
| | `components/ConfusionHeatmap.tsx` |
| | `components/ConfusionDetail.tsx` |
| **服务** | `services/classroom-data-service.ts` (25KB) |
| | `services/parent-service.ts` |
| **Hooks** | `lib/hooks/useClassroomData.ts` |

### 开发者 E - 基建/认证模块

| 主要负责 | 文件路径 |
|----------|----------|
| **页面** | `app/(auth)/*` (登录/注册/个人资料) |
| **API** | `api/auth/*` (全部认证接口) |
| **服务** | `services/auth-service.ts` (21KB) |
| | `services/wechat-auth-service.ts` |
| **Hooks** | `lib/hooks/useAuth.tsx` (9KB) |
| **中间件** | `middleware.ts` |
| **数据库** | `lib/prisma.ts` |
| | `prisma/schema.prisma` |
| **配置** | `lib/config/app.config.ts` |

---

## ⚠️ 高冲突风险文件（需特别管理）

### 1. `src/app/page.tsx` (~82KB 巨型文件)

**当前状态**：包含大量 useState，已开始迁移到 SWR Hooks

**拆分建议**：
```
app/page.tsx (协调层，~20KB)
├── features/recording/      ← 开发者 A
│   ├── RecordingSection.tsx
│   └── useRecordingState.ts
├── features/review/         ← 开发者 B/C
│   ├── ReviewSection.tsx
│   └── useReviewState.ts
├── features/ai-tutor/       ← 开发者 B
│   └── TutorSection.tsx
└── stores/                  ← 共同维护
    ├── ui-store.ts (已存在)
    └── player-store.ts (已存在)
```

**临时协作规则**：
- 修改前在群里喊一声
- 尽量修改独立的函数/区块
- PR 必须包含 `page.tsx` 标签

### 2. `src/lib/db/` (已拆分 ✅)

**当前结构**：
```
lib/db/
├── index.ts          ← 统一导出（保持 @/lib/db 导入兼容）
├── schema.ts         ← 数据库定义 + 类型（~200行）
├── sessions.ts       ← AudioSession 操作（~70行）
├── anchors.ts        ← Anchor 操作（~40行）
├── transcripts.ts    ← TranscriptSegment 操作（~30行）
├── highlights.ts     ← HighlightTopic 操作（~50行）
├── summaries.ts      ← ClassSummary 操作（~50行）
├── notes.ts          ← Note 操作（~90行）
├── conversations.ts  ← 对话历史操作（~180行）
├── tutor-cache.ts    ← TutorResponseCache 操作（~70行）
└── preferences.ts    ← Preference 操作（~20行）
```

**Owner 分配**：
| 文件 | Owner | 功能模块 |
|------|-------|----------|
| `sessions.ts` | 开发者 A | 录音转写 |
| `anchors.ts` | 开发者 A | 录音转写 |
| `transcripts.ts` | 开发者 A | 录音转写 |
| `highlights.ts` | 开发者 C | 笔记内容 |
| `summaries.ts` | 开发者 C | 笔记内容 |
| `notes.ts` | 开发者 C | 笔记内容 |
| `conversations.ts` | 开发者 B | AI家教 |
| `tutor-cache.ts` | 开发者 B | AI家教 |
| `preferences.ts` | 开发者 E | 基建 |

**兼容性**：原有 `import { db, ... } from '@/lib/db'` 无需修改

### 3. `src/types/index.ts` (~10KB)

**协作规则**：
- 谁新增类型谁负责
- 用注释标记 owner
- 相关类型放在一起

```typescript
// ============ 录音相关 [Owner: A] ============
export interface TranscriptSegment { ... }

// ============ AI 家教相关 [Owner: B] ============
export interface TutorResponse { ... }

// ============ 笔记相关 [Owner: C] ============
export interface Note { ... }
export interface HighlightTopic { ... }
```

### 4. `src/stores/*.ts` (新增的 Zustand Stores)

**协作规则**：
- `ui-store.ts` - 全员可用，修改需 PR
- `player-store.ts` - 主要由 A/B 维护
- 新增 store 需要讨论确认

### 5. `src/hooks/data/*.ts` (新增的 SWR Hooks)

| Hook | Owner |
|------|-------|
| `useTutor.ts` | 开发者 B |
| `useSummary.ts` | 开发者 C |
| `useTopics.ts` | 开发者 C |
| `useSession.ts` | 开发者 A |
| `useTranscript.ts` | 开发者 A/C |

---

## 🌿 Git 分支策略

```
main (保护分支，只接受 PR)
 │
 ├── develop (集成分支，每日合并)
 │    │
 │    ├── feature/recording-vad-improvement    ← 开发者 A
 │    ├── feature/tutor-multi-turn-context     ← 开发者 B
 │    ├── feature/notes-export-pdf             ← 开发者 C
 │    ├── feature/parent-dashboard-charts      ← 开发者 D
 │    ├── feature/wechat-login-refresh         ← 开发者 E
 │    │
 │    └── refactor/page-split                  ← 需要多人协作
 │
 └── hotfix/* (紧急修复)
```

---

## 🤖 AI Agent 协作规则（AI 原生团队适用）

> 适用于大量使用 Coding Agent（如 CodeBuddy、Cursor、Copilot）的团队

### 文件大小限制

| 类型 | 行数限制 | 说明 |
|------|----------|------|
| 组件文件 | < 400 行 | 超过则拆分子组件 |
| Store 文件 | < 150 行 | 每个 store 职责单一 |
| DB 操作文件 | < 100 行 | 按功能域拆分 |
| Service 文件 | < 300 行 | 按业务边界拆分 |

### page.tsx 修改指南（针对 Agent）

由于 `page.tsx` 较大（~1800行），Agent 修改时：

1. **先读取需要修改的部分**（使用 offset/limit 参数）
2. **修改范围尽量小**，避免大段重写
3. **修改后验证**：
   ```bash
   npx tsc --noEmit  # 类型检查
   npm run dev       # 启动验证
   ```
4. **状态相关改动**优先考虑迁移到 `stores/`

### Agent 前置检查清单

Agent 在修改任何文件前，必须：

- [ ] 读取该文件当前内容（确保不覆盖他人改动）
- [ ] 检查 `types/index.ts` 了解相关类型
- [ ] 如果涉及数据库，查看 `lib/db/` 对应模块
- [ ] 如果涉及 API，检查相关 SWR Hook

### 新增代码规范

| 场景 | 应该放到 |
|------|----------|
| 新增客户端状态 | `stores/` 对应 store |
| 新增 API 请求 | `hooks/data/` 创建 SWR Hook |
| 新增数据库操作 | `lib/db/` 对应模块 |
| 新增类型定义 | `types/index.ts` 并标记 Owner |

### Agent 验证清单

每次改完代码，Agent 必须执行：

```bash
# 1. 类型检查
npx tsc --noEmit

# 2. 启动验证（如有开发服务器）
npm run dev

# 3. 如果修改了 UI，截图验证
```

### 高冲突文件协调

以下文件多 Agent 可能同时修改，需要协调：

| 文件 | 风险等级 | 协调方式 |
|------|----------|----------|
| `app/page.tsx` | 🔴 高 | 群里喊一声 + PR 标签 |
| `types/index.ts` | 🟡 中 | 新增类型标记 Owner |
| `stores/*.ts` | 🟡 中 | 新增 action 需 PR |
| `lib/db/index.ts` | 🟢 低 | 只改导出，不改实现 |

---

## 🤝 协作规范

### 1. 接口契约先行

在 `src/types/contracts.ts` 中定义接口：

```typescript
// 开发者 B 定义，开发者 A/C 依赖
export interface TutorRequest {
  question: string;
  segments: TranscriptSegment[];
  sessionId: string;
}

// 开发者 C 定义，开发者 B 依赖
export interface HighlightTopicResult {
  topics: HighlightTopic[];
  generationMode: TopicGenerationMode;
}
```

### 2. PR 模板

```markdown
## 改动模块
- [ ] 🎙️ 录音转写
- [ ] 🤖 AI家教
- [ ] 📝 笔记/内容
- [ ] 👨‍👩‍👧 家长/教师端
- [ ] 🔐 认证基建

## 影响的共享文件
- [ ] app/page.tsx
- [ ] lib/db.ts
- [ ] types/index.ts
- [ ] stores/*.ts
- [ ] hooks/data/*.ts
- [ ] prisma/schema.prisma

## 是否需要数据库迁移
- [ ] 是 → 需等待全员确认
- [ ] 否

## 是否影响 SWR 缓存 Key
- [ ] 是 → 需要通知相关模块 Owner
- [ ] 否
```

### 3. 每日同步机制

| 时间 | 事项 |
|------|------|
| 早会 5 分钟 | 今天谁会碰什么共享文件 |
| 下班前 | 各自 rebase develop，解决冲突 |
| 周五 | develop → main 合并 |

---

## 🎯 立即可执行的准备工作

### ✅ 已完成

- [x] **拆分 db.ts** → `lib/db/` 目录（10个子模块）
- [x] **添加 Agent 协作规则**

### Phase 1：拆分 page.tsx（按需，渐进式）

> 策略：不主动大规模重构，在功能开发时顺便迁移

1. **新增状态 → 放到 Zustand**（而非 useState）
2. **修改录音相关 → 考虑提取到 RecordView**
3. **修改复习相关 → 考虑提取到 ReviewView**

### Phase 2：创建 contracts.ts（全员参与）

1. **定义模块间接口**
2. **文档化数据流向**

---

## 📊 团队规模建议

| 团队规模 | 推荐策略 |
|----------|----------|
| 2-3人 | 不需要严格分模块，但约定好「谁今天碰哪个文件」 |
| 4-6人 | 上述 5 模块分工，每人「拥有」一个模块 |
| 7+人 | 考虑拆分微服务：录音服务/AI服务/用户服务独立部署 |

**当前 MeetMind 状态**：单体应用 + SWR/Zustand 基础设施，适合 3-6 人团队并行开发。

---

*文档版本：v2.1*
*更新日期：2026-01-22*
*更新内容：完成 db.ts 拆分，新增 AI Agent 协作规则*
