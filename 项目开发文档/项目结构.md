# MeetMind 项目结构

> 详细的目录结构和文件说明

---

## 目录结构

```
meetmind/
├── server.js                    # 自定义服务器 (WebSocket ASR 代理 + Next.js)
├── package.json                 # 项目依赖
├── .env.example                 # 环境变量示例
├── next.config.js               # Next.js 配置
├── tailwind.config.js           # Tailwind CSS 配置
├── tsconfig.json                # TypeScript 配置
│
├── public/                      # 静态资源
│   ├── demo.mp3                 # 演示音频
│   └── temp-audio/              # 临时音频目录（异步转录用，自动清理）
│
└── src/
    ├── middleware.ts            # Next.js 中间件 (认证、路由控制)
    │
    ├── app/                     # Next.js App Router 页面
    │   ├── layout.tsx           # 根布局 (AuthProvider)
    │   ├── page.tsx             # 学生端首页 (录音/复习)
    │   ├── globals.css          # 全局样式
    │   │
    │   ├── parent/              # 家长端
    │   │   └── page.tsx         # 日报查看、陪学脚本
    │   │
    │   ├── teacher/             # 教师端
    │   │   └── page.tsx         # 困惑热点、教学反思
    │   │
    │   ├── all-notes/           # 全部笔记页面
    │   │   └── page.tsx
    │   │
    │   ├── (auth)/              # 认证相关页面组
    │   │   ├── login/page.tsx
    │   │   ├── register/page.tsx
    │   │   └── profile/page.tsx
    │   │
    │   └── api/                 # API 路由
    │       ├── auth/            # 认证 API (登录/注册/微信)
    │       ├── tutor/route.ts   # AI 家教核心 API
    │       ├── chat/route.ts    # 通用 AI 对话
    │       ├── transcribe/      # 语音转录 (阿里云异步 ASR)
    │       ├── generate-topics/ # 精选片段生成
    │       ├── generate-summary/# 课堂摘要生成
    │       ├── upload-audio/    # 音频上传
    │       └── asr-config/      # ASR 配置
    │
    ├── components/              # React 组件
    │   ├── index.ts             # 统一导出
    │   │
    │   ├── ui/                  # 基础 UI 组件 (shadcn/ui)
    │   │   ├── button.tsx
    │   │   ├── card.tsx
    │   │   ├── dialog.tsx
    │   │   ├── input.tsx
    │   │   ├── select.tsx
    │   │   ├── tabs.tsx
    │   │   └── ...
    │   │
    │   ├── mobile/              # 移动端专用组件
    │   │   ├── MobileRecorder.tsx      # 移动端录音器
    │   │   ├── MobileReviewPanel.tsx   # 移动端复习面板
    │   │   ├── MobileAITutor.tsx       # 移动端 AI 家教
    │   │   ├── MiniPlayer.tsx          # 迷你播放器
    │   │   └── ...
    │   │
    │   ├── teacher/             # 教师端专用组件
    │   │   ├── TeacherDashboard.tsx     # 教师仪表盘
    │   │   ├── ConfusionHotspotCard.tsx # 困惑热点卡片
    │   │   └── ReflectionGenerator.tsx  # 教学反思生成器
    │   │
    │   ├── business/            # 业务组件
    │   │   ├── LearningCard.tsx        # 学习卡片
    │   │   ├── ProgressRing.tsx        # 进度环
    │   │   └── ...
    │   │
    │   ├── layout/              # 布局组件
    │   │   └── ...
    │   │
    │   │   # 核心功能组件
    │   ├── Recorder.tsx         # 录音器 (实时 ASR)
    │   ├── AudioPlayer.tsx      # 音频播放器
    │   ├── WaveformPlayer.tsx   # 波形播放器 (WaveSurfer)
    │   │
    │   │   # AI 交互组件
    │   ├── AITutor.tsx          # AI 家教面板
    │   ├── AIChat.tsx           # AI 对话组件
    │   ├── ModelSelector.tsx    # 模型选择器
    │   │
    │   │   # 时间轴与内容组件
    │   ├── TimelineView.tsx     # 时间轴视图
    │   ├── HighlightsPanel.tsx  # 精选片段面板
    │   ├── SummaryPanel.tsx     # 课堂摘要面板
    │   ├── NotesPanel.tsx       # 笔记面板
    │   │
    │   │   # 可视化组件
    │   ├── ConfusionHeatmap.tsx # 困惑热力图
    │   │
    │   │   # 布局组件
    │   ├── Header.tsx           # 页头导航
    │   └── ActionList.tsx       # 行动清单
    │
    ├── hooks/                   # 自定义 Hooks
    │   ├── index.ts             # 统一导出
    │   ├── useAnchors.ts        # 困惑点管理 Hook
    │   ├── useAudio.ts          # 音频播放控制
    │   ├── useAudioSessions.ts  # IndexedDB 会话查询（Dexie 响应式）
    │   ├── useRecording.ts      # 录音状态管理
    │   ├── useResponsive.ts     # 响应式布局状态
    │   ├── useTranscript.ts     # 转录数据管理
    │   └── useDragGesture.ts    # 拖拽手势
    │
    ├── lib/                     # 核心库
    │   ├── config.ts            # 旧配置文件（已迁移到 config/）
    │   ├── utils.ts             # 旧工具函数（已迁移到 utils/）
    │   ├── db.ts                # IndexedDB 数据库 (Dexie)
    │   │
    │   ├── config/              # 统一配置管理（新）
    │   │   ├── app.config.ts    # 应用配置 (LLM/Auth/ASR/Feature/UI)
    │   │   └── index.ts         # 配置导出
    │   │
    │   ├── utils/               # 工具函数（新）
    │   │   ├── index.ts         # 统一导出
    │   │   ├── time-utils.ts    # 时间处理工具
    │   │   ├── json-utils.ts    # JSON 解析工具
    │   │   └── transcript-utils.ts # 转录文本处理
    │   │
    │   ├── services/            # 服务层
    │   │   ├── index.ts         # 统一导出
    │   │   │
    │   │   │   # AI/LLM 服务
    │   │   ├── llm-service.ts           # LLM 调用封装 (通义千问/Gemini/OpenAI)
    │   │   ├── dify-service.ts          # Dify 工作流服务
    │   │   ├── tutor-service.ts         # AI 家教服务
    │   │   │
    │   │   │   # ASR 语音识别
    │   │   ├── qwen-asr-service.ts      # 通义千问 ASR (同步/异步)
    │   │   ├── dashscope-asr-service.ts # DashScope 实时 ASR 客户端
    │   │   │
    │   │   │   # 核心业务服务
    │   │   ├── meetmind-service.ts      # MeetMind 核心业务
    │   │   ├── anchor-service.ts        # 困惑点管理
    │   │   ├── memory-service.ts        # 时间轴记忆服务
    │   │   ├── classroom-data-service.ts# 课堂数据共享 (学生↔教师)
    │   │   │
    │   │   │   # 内容生成服务
    │   │   ├── highlight-service.ts     # 精选片段生成
    │   │   ├── summary-service.ts       # 课堂摘要生成
    │   │   ├── note-service.ts          # 笔记服务
    │   │   │
    │   │   │   # 角色专用服务
    │   │   ├── parent-service.ts        # 家长端服务
    │   │   ├── auth-service.ts          # 认证服务
    │   │   └── teaching-suggestion.ts   # 教学建议生成
    │   │
    │   ├── hooks/               # 认证相关 Hooks
    │   │   └── useAuth.tsx      # 认证 Hook
    │   │
    │   └── longcut/             # 时间轴处理工具
    │       └── ...
    │
    ├── types/                   # TypeScript 类型定义
    │   ├── index.ts             # 核心业务类型 (Anchor, TranscriptSegment, etc.)
    │   ├── user.ts              # 用户/认证类型 (User, UserRole, etc.)
    │   └── dify.ts              # Dify 服务类型
    │
    └── fixtures/                # 演示数据
        └── demo-data.ts         # 统一演示数据源
```

---

## 核心目录说明

### `/src/app` - 页面路由

使用 Next.js App Router，按文件系统路由组织：

| 路径 | 说明 |
|------|------|
| `/` | 学生端首页（录音/复习模式） |
| `/parent` | 家长端（日报、陪学脚本） |
| `/teacher` | 教师端（困惑热点、教学反思） |
| `/all-notes` | 全部笔记页面 |
| `/(auth)/*` | 认证页面组（登录/注册/个人中心） |
| `/api/*` | API 路由 |

### `/src/components` - React 组件

按功能分类组织：

| 分类 | 组件 |
|------|------|
| **基础 UI** | button, card, dialog, input, select, tabs, ... (shadcn/ui) |
| **音频组件** | Recorder, AudioPlayer, WaveformPlayer |
| **AI 交互** | AITutor, AIChat, ModelSelector |
| **时间轴** | TimelineView, HighlightsPanel, SummaryPanel |
| **可视化** | ConfusionHeatmap |
| **布局** | Header, ActionList |
| **移动端** | MobileRecorder, MobileReviewPanel, MobileAITutor, MiniPlayer |
| **教师端** | TeacherDashboard, ConfusionHotspotCard, ReflectionGenerator |
| **业务组件** | LearningCard, ProgressRing |

### `/src/hooks` - 自定义 Hooks

**v1.6 重构**：从 `page.tsx` 提取 4 个核心业务 Hooks，降低主页面复杂度。

| Hook | 说明 |
|------|------|
| `useAnchors` | 困惑点 CRUD 操作、状态管理、`updateAnchorStatus` 方法 |
| `useAudio` | 音频播放控制（播放/暂停/跳转/倍速/音量） |
| `useAudioSessions` | IndexedDB 会话查询（Dexie 响应式 `useLiveQuery`） |
| `useRecording` | 录音状态管理（开始/停止/暂停/恢复） |
| `useResponsive` | 响应式布局状态检测（移动端/桌面端） |
| `useTranscript` | 转录数据加载/保存/实时更新 |
| `useDragGesture` | 拖拽手势处理（触摸/鼠标） |

### `/src/lib/config` - 配置管理

**v1.6 重构**：将散落各处的硬编码配置统一到 `app.config.ts`，敏感信息移至环境变量。

| 配置项 | 说明 |
|--------|------|
| `LLMConfig` | LLM 模型配置（默认模型、API Key、可用模型列表、baseURL） |
| `AuthConfig` | 认证配置（JWT 密钥从环境变量读取、密码策略、登录限流） |
| `ASRConfig` | 语音识别配置（实时模型、异步模型、采样率、分块大小） |
| `FeatureConfig` | 功能配置（精选片段、摘要、家长端、AI 家教开关） |
| `UIConfig` | UI 配置（`defaultSubject` 默认学科、分页大小、动画时长） |
| `DevConfig` | 开发配置（调试模式、演示模式、日志级别） |

### 环境变量配置

| 变量 | 说明 |
|------|------|
| `DASHSCOPE_API_KEY` | 阿里云百炼 API Key（必需） |
| `DASHSCOPE_ASR_WS_MODEL` | 实时语音识别模型（默认 qwen3-asr-flash-realtime） |
| `PUBLIC_HOST` | 公网访问地址（异步转录需要，如 47.112.160.134:3001） |
| `PUBLIC_PROTOCOL` | 公网协议（http/https） |

### `/src/lib/utils` - 工具函数

**重构背景**：v1.6 版本消除了 4 处重复的 `formatTimestamp` 函数定义，统一到模块化工具函数中。

| 工具 | 说明 |
|------|------|
| `time-utils.ts` | 时间格式化（`formatTimestamp`、`formatTimeRange`）、毫秒/秒转换、`TimeSegment` 泛型接口 |
| `json-utils.ts` | 安全 JSON 解析（`safeParseJSON`）、从 Markdown 代码块提取 JSON（`extractJSONFromMarkdown`） |
| `transcript-utils.ts` | 转录文本合并（`mergeTranscriptSegments`）、文本清洗、分块处理 |

### `/src/lib/services` - 服务层

**v1.6 重构**：统一服务文件风格，使用统一工具函数（`time-utils`、`json-utils`），移除硬编码配置。

| 分类 | 服务 |
|------|------|
| **AI/LLM** | llm-service（使用 LLMConfig）, dify-service, tutor-service（使用统一工具函数） |
| **ASR** | qwen-asr-service, dashscope-asr-service |
| **核心业务** | meetmind-service, anchor-service（补齐 updateAnchorStatus）, memory-service, classroom-data-service |
| **内容生成** | highlight-service（使用 time-utils）, summary-service（使用 json-utils）, note-service |
| **角色专用** | parent-service（使用统一配置）, auth-service（移除硬编码管理员账户）, teaching-suggestion |

### `/src/types` - 类型定义

**v1.6 类型系统重构**：区分 DB 层和应用层类型，避免 `id` 类型混淆。

| 类型 | 说明 |
|------|------|
| `DBAnchor` | 数据库层困惑点（id: number，对应 IndexedDB 自增主键） |
| `DBTranscriptSegment` | 数据库层转录片段（id: number） |
| `Anchor` | 应用层困惑点（id: string） |
| `TranscriptSegment` | 应用层转录片段（id: string） |
| `BaseTranscriptSegment<T>` | 泛型基础接口，兼容 DB/应用层 |
| `dbToTranscriptSegment()` | DB → 应用层类型转换函数 |

| 文件 | 说明 |
|------|------|
| `index.ts` | 核心业务类型（Anchor, TranscriptSegment, ClassTimeline, DBAnchor, DBTranscriptSegment 等） |
| `user.ts` | 用户/认证类型（User, UserRole, ParentStudentLink 等） |
| `dify.ts` | Dify 服务类型 |

---

## 数据存储

### IndexedDB (Dexie.js)

| 表 | 说明 |
|----|------|
| `audioSessions` | 音频会话（sessionId, audioBlob, duration, subject） |
| `transcripts` | 转录片段（id, sessionId, text, startMs, endMs） |
| `anchors` | 困惑点（id, sessionId, timestamp, type, resolved） |
| `highlightTopics` | 精选片段（id, sessionId, title, segments） |
| `classSummaries` | 课堂摘要（id, sessionId, overview, takeaways） |
| `notes` | 笔记（id, sessionId, content, timestamp） |
| `tutorResponseCache` | AI 家教响应缓存（anchorId, response, model） |
| `preferences` | 用户偏好设置 |

### localStorage

| Key | 说明 |
|-----|------|
| `meetmind_access_token` | JWT 认证令牌 |
| `meetmind_refresh_token` | 刷新令牌 |
| `app_last_state` | 应用状态（viewMode, sessionId 等） |

---

*文档版本：v2.1*  
*更新时间：2026-01-19*  
*更新内容：补充 v1.6 重构详细说明（类型系统、Hooks、服务层、配置管理）*
