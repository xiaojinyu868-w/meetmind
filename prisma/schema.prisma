// Prisma Schema for MeetMind
// 使用 SQLite 作为内测数据库，后续可轻松迁移到 MySQL/PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// 用户表
model User {
  id           String   @id @default(cuid())
  username     String   @unique
  email        String?  @unique
  phone        String?  @unique
  nickname     String
  avatar       String?
  role         String   @default("student") // student, parent, teacher, admin
  status       String   @default("active")  // active, inactive, suspended, pending
  passwordHash String?
  salt         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  lastLoginAt  DateTime?

  // 关联
  authProviders AuthProvider[]
  sessions      Session[]
  refreshTokens RefreshToken[]

  @@index([username])
  @@index([email])
  @@index([phone])
}

// 第三方登录关联表
model AuthProvider {
  id           String   @id @default(cuid())
  userId       String
  provider     String   // local, wechat, google, apple
  providerId   String   // 第三方平台的用户ID
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
}

// 用户会话表
model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  userAgent String?
  ip        String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// 刷新令牌表
model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

// 登录限流记录表
model LoginAttempt {
  id           String   @id @default(cuid())
  identifier   String   // 用户名/邮箱/手机号/IP
  count        Int      @default(1)
  firstAttempt DateTime @default(now())
  lockedUntil  DateTime?

  @@unique([identifier])
}

// CSRF Token 表
model CsrfToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String?
  createdAt DateTime @default(now())

  @@index([token])
}
